function userLogout(){$.ajax({url:"/user/logout",success:function(){}})}function userGetInfo(){$.ajax({url:"/user/getprofile",success:function(e){e.email?displayProfile(e):$(".user-login").show()}})}function displayProfile(e){$(".user-info").html(e.displayName)}function trucksNearbyHeight(){var e=$(".map-container").height(),a=$(".trucks-nearby").css("margin-top");a=parseInt(a);var t=e-2*a;$(".trucks-nearby").css("max-height",t+"px"),truckListingHeight()}function truckListingHeight(){$(".truck-listing").css("max-height","");var e=parseInt($(".trucks-nearby").height()),a=parseInt($(".trucks-nearby-header").outerHeight(!0)),t=parseInt($(".trucks-nearby-footer").outerHeight(!0)),n=e-(a+t);n+="px",$(".truck-listing").css("max-height",n)}function getMarkerData(){$.ajax({url:"/mapdata/getmarkers",success:function(e){return mapMarkers=e,populateMap(mapMarkers),e}})}function geolocateUser(){console.log("geolocating"),navigator.geolocation||console.log("Geolocation is not available"),map.locate(),map.on("locationfound",function(e){console.log("location found"),fixedMarker=L.marker(new L.LatLng(e.latlng.lat,e.latlng.lng),{}),map.setView([e.latlng.lat,e.latlng.lng],14),mapMarkers&&populateMap(mapMarkers)}),map.on("locationerror",function(){console.log("Position could not be found")})}function populateMap(e){function a(e){for(var a=n.getElementsByTagName("div"),t=0;t<a.length;t++)a[t].className=a[t].className.replace(/active/,"").replace(/\s\s*$/,"");e.className+=" active"}var t=[],n=document.getElementById("listings");n.innerHTML="";var o=L.mapbox.featureLayer().addTo(map);o.setGeoJSON(e),o.eachLayer(function(e){var n=fixedMarker.getLatLng(),o=.000621371192,r=(o*n.distanceTo(e.getLatLng())).toFixed(1);console.log(r);var i=e.feature.properties,s="<h3>"+i.truckName+'</h3><div class="info">'+i.simpleAddress;s+="</div>";var c=document.createElement("div");c.className="truck",c.setAttribute("data-distance",r);var u=c.appendChild(document.createElement("a"));u.href="#",u.className="truck-link",u.innerHTML="<h3>"+i.truckName+"</h3>",u.innerHTML+="<div class='address'>"+i.simpleAddress+"</div>",u.innerHTML+="<div class='city'>"+i.city+"</div></div>",u.innerHTML+="<div class='distance'>"+r+" mi. away</div></div>",t.push(c),u.onclick=function(){return a(c),map.setView(e.getLatLng(),16),e.openPopup(),!1},e.on("click",function(t){map.panTo(e.getLatLng(),16),a(c)}),e.bindPopup(s),e.setIcon(L.icon({iconUrl:"/assets/images/map-markers/marker.png",iconSize:[66,50],iconAnchor:[33,50],popupAnchor:[0,-50]}))}),console.log(t),t.sort(function(e,a){return e.getAttribute("data-distance")-a.getAttribute("data-distance")}),t.forEach(function(e){n.appendChild(e)}),trucksNearbyHeight()}var mapboxToken="pk.eyJ1IjoianJrZWNrIiwiYSI6IjgzZTA0NmVhOGUxMjc2NjhmODYwYmQ3ZGIyZTRkOWQ1In0.XM9mizd6bF8zCqwafrGLDQ";$(document).ready(function(){userGetInfo(),$(".user-logout").on("click",function(){userLogout()})}),$(document).ready(function(){$(window).resize(function(){trucksNearbyHeight()}),$("body").on("click",".menu-close",function(){$(".trucks-nearby").removeClass("active")}),$("body").on("click",".footer-nav .map-list",function(){$(".trucks-nearby").toggleClass("active"),setTimeout(truckListingHeight,700)})});var mapMarkers;L.mapbox.accessToken=mapboxToken;var map=L.mapbox.map("map","jrkeck.7fbfb356");map.setView([44.98,-93.2638],14);var fixedMarker=L.marker(new L.LatLng(44.95,-93.2638),{});geolocateUser(),getMarkerData();