function userLogout(){$.ajax({url:"/user/logout",success:function(){}})}function userGetInfo(){$.ajax({url:"/user/getprofile",success:function(t){t.email?displayProfile(t):$(".user-login").show()}})}function displayProfile(t){$(".user-info").html(t.displayName)}function trucksNearbyHeight(){var t=$(".map-container").height(),e=$(".trucks-nearby").css("margin-top");e=parseInt(e);var i=t-2*e;$(".trucks-nearby").css("max-height",i+"px"),truckListingHeight()}function truckListingHeight(){$(".truck-listing").css("max-height","");var t=parseInt($(".trucks-nearby").height()),e=parseInt($(".trucks-nearby-header").outerHeight(!0)),i=parseInt($(".trucks-nearby-footer").outerHeight(!0)),n=t-(e+i);n+="px",$(".truck-listing").css("max-height",n)}function getMarkerData(){$.ajax({url:"/mapdata/getmarkers",success:function(t){return mapMarkers=t,populateMap(mapMarkers),t}})}function geolocateUser(){console.log("geolocating"),navigator.geolocation||console.log("Geolocation is not available"),map.locate(),map.on("locationfound",function(t){console.log("location found"),fixedMarker=L.marker(new L.LatLng(t.latlng.lat,t.latlng.lng),{}),map.setView([t.latlng.lat,t.latlng.lng],14),mapMarkers&&populateMap(mapMarkers)}),map.on("locationerror",function(){console.log("Position could not be found")})}function populateMap(t){function e(t){for(var e=n.getElementsByTagName("div"),i=0;i<e.length;i++)e[i].className=e[i].className.replace(/active/,"").replace(/\s\s*$/,"");t.className+=" active"}var i=[],n=document.getElementById("listings");n.innerHTML="";var o=L.mapbox.featureLayer().addTo(map);o.setGeoJSON(t),o.eachLayer(function(t){var n=fixedMarker.getLatLng(),o=.000621371192,a=(o*n.distanceTo(t.getLatLng())).toFixed(1),r=t.feature.properties,s="<h3>"+r.truckName+'</h3><div class="info">'+r.simpleAddress;s+="</div>";var c=document.createElement("div");c.className="truck",c.setAttribute("data-distance",a);var u=c.appendChild(document.createElement("a"));u.href="#",u.className="truck-link",u.innerHTML="<h3>"+r.truckName+"</h3>",u.innerHTML+="<div class='address'>"+r.simpleAddress+"</div>",u.innerHTML+="<div class='city'>"+r.city+"</div></div>",u.innerHTML+="<div class='distance'>"+a+" mi. away</div></div>",i.push(c),u.onclick=function(){return e(c),map.setView(t.getLatLng(),16),t.openPopup(),!1},t.on("click",function(i){map.panTo(t.getLatLng(),16),e(c)}),t.bindPopup(s),t.setIcon(L.icon({iconUrl:"/assets/images/map-markers/marker.png",iconSize:[66,50],iconAnchor:[33,50],popupAnchor:[0,-50]}))}),i.sort(function(t,e){return t.getAttribute("data-distance")-e.getAttribute("data-distance")}),i.forEach(function(t){n.appendChild(t)}),trucksNearbyHeight()}var mapboxToken="pk.eyJ1IjoianJrZWNrIiwiYSI6IjgzZTA0NmVhOGUxMjc2NjhmODYwYmQ3ZGIyZTRkOWQ1In0.XM9mizd6bF8zCqwafrGLDQ";$(document).ready(function(){userGetInfo(),$(".user-logout").on("click",function(){userLogout()})}),$(document).ready(function(){$(window).resize(function(){trucksNearbyHeight()}),$("body").on("click",".menu-close",function(){$(".trucks-nearby").removeClass("active")}),$("body").on("click",".footer-nav .map-list",function(){$(".trucks-nearby").toggleClass("active"),setTimeout(truckListingHeight,700)})}),function(t){"undefined"==typeof t&&(t={getCenter:L.Map.prototype.getCenter,setView:L.Map.prototype.setView,setZoomAround:L.Map.prototype.setZoomAround,getBoundsZoom:L.Map.prototype.getBoundsZoom,scaleUpdate:L.Control.Scale.prototype._update}),L.Map.include({getBounds:function(){if(this._viewport)return this.getViewportLatLngBounds();var t=this.getPixelBounds(),e=this.unproject(t.getBottomLeft()),i=this.unproject(t.getTopRight());return new L.LatLngBounds(e,i)},getViewport:function(){return this._viewport},getViewportBounds:function(){var t=this._viewport,e=L.point(t.offsetLeft,t.offsetTop),i=L.point(t.clientWidth,t.clientHeight);return(0===i.x||0===i.y)&&(t=this.getContainer(),t&&(e=L.point(0,0),i=L.point(t.clientWidth,t.clientHeight))),L.bounds(e,e.add(i))},getViewportLatLngBounds:function(){var t=this.getViewportBounds();return L.latLngBounds(this.containerPointToLatLng(t.min),this.containerPointToLatLng(t.max))},getOffset:function(){var t=this.getSize().divideBy(2),e=this.getViewportBounds().getCenter();return t.subtract(e)},getCenter:function(){var e=t.getCenter.call(this);if(this.getViewport()){var i=this.getZoom(),n=this.project(e,i);n=n.subtract(this.getOffset()),e=this.unproject(n,i)}return e},setView:function(e,i,n){if(e=L.latLng(e),i=i||this.getZoom(),this.getViewport()){var o=this.project(e,this._limitZoom(i));o=o.add(this.getOffset()),e=this.unproject(o,this._limitZoom(i))}return t.setView.call(this,e,i,n)},setZoomAround:function(e,i,n){var o=this.getViewport();if(o){var a=this.getZoomScale(i),r=this.getViewportBounds().getCenter(),s=e instanceof L.Point?e:this.latLngToContainerPoint(e),c=s.subtract(r).multiplyBy(1-1/a),u=this.containerPointToLatLng(r.add(c));return this.setView(u,i,{zoom:n})}return t.setZoomAround.call(this,e,i,n)},getBoundsZoom:function(t,e,i){t=L.latLngBounds(t);var n,o=this.getMinZoom()-(e?1:0),a=this.getMaxZoom(),r=this.getViewport(),s=r?L.point(r.clientWidth,r.clientHeight):this.getSize(),c=t.getNorthWest(),u=t.getSouthEast(),p=!0;i=L.point(i||[0,0]);do o++,n=this.project(u,o).subtract(this.project(c,o)).add(i),p=e?n.x<s.x||n.y<s.y:s.contains(n);while(p&&a>=o);return p&&e?null:e?o:o-1}}),L.Control.Scale.include({_update:function(){if(this._map._viewport){var e=this._map.getBounds(),i=e.getCenter().lat,n=6378137*Math.PI*Math.cos(i*Math.PI/180),o=n*(e.getNorthEast().lng-e.getSouthWest().lng)/180,a=this._map.getSize(),r=this.options,s=0,a=new L.Point(this._map._viewport.clientWidth,this._map._viewport.clientHeight);a.x>0&&(s=o*(r.maxWidth/a.x)),this._updateScales(r,s)}else t.scaleUpdate.call(this)}}),L.Map.include({setActiveArea:function(t){if(!this._viewport){var e=this.getContainer();this._viewport=L.DomUtil.create("div",""),e.insertBefore(this._viewport,e.firstChild)}return"string"==typeof t?this._viewport.className=t:L.extend(this._viewport.style,t),this}})}(window.leafletActiveAreaPreviousMethods);var mapMarkers;L.mapbox.accessToken=mapboxToken;var map=L.mapbox.map("map","jrkeck.7fbfb356");map.setActiveArea("map-active").setView([44.98,-93.2638],14);var fixedMarker=L.marker(new L.LatLng(44.95,-93.2638),{});geolocateUser(),getMarkerData();